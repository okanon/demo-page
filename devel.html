<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="ja" http-equiv="content-language">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">

    <title>LineInc</title>
    <meta content="LineInc" property="og:title">
    <meta content="ja_JP" property="og:locale">
    <meta content="LineBot" name="description">
    <meta content="LineBot" property="og:description">

    <link href="css/main.css" rel="stylesheet">
    <link href="css/credits.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="css/devel.css" rel="stylesheet">
    
</head>
<body>
    <a href="."><img class="logo_size" src="logo.png"></a>
    <p class="credits-top">LINE v9.15.0 and WINDOWS LINE v5.19.0.2020 API by <a class="line-link" href="https://github.com/okanon" target="_blank">@okanon</a>.</p>
    <p class="credits-top">framework made by <a class="line-link" href="https://github.com/okanon" target="_blank">@okanon</a> &amp; <a class="line-link" href="https://github.com/54mch4n" target="_blank">@54m</a></p>

    <div style="padding-top: 30px;">
    	<h2 style="margin-bottom: 10px;">Login</h2>
        <ol class="dotted-list" style="padding-bottom: 10px;">
            <li>メールアドレス &amp; パスワード</li>
            <li>メールアドレス &amp; パスワード &amp; ログイン証明</li>
            <li>QRコード</li>
            <li>authToken（アクセストークン）</li>
        </ol>
        <p class="description">LINEサーバへのログイン方法には上記の4つが存在する。以下のセクションでは、各ログイン方法について解説していく。</p>
        
        <h3 style="padding-top: 5px;">ID &amp; Password</h3>
        <p class="description">
            ここでは、idとパスワード、そしてRSA暗号化に必要なデータを、LINEアプリケーションサーバないしはLINEサーバから取得し、それらを使用して暗号キーを生成する。
            取得されたデータは以下の形式である。<span style="font-size: 11px;"> &ast;LINEアカウントにメールアドレスが紐付けられていることを前提とする</span>
        </p>
        
        <div style="padding-top: 5px">
            <pre class="language-x hljs">
                <code class="language-X hljs" data-language="json">{
  "session_key": "L|Hh73z12LwU",
  "rsa_key": "8322,940158fcb00e15c7cf0b85a4dc0c3b5789ce809e614ac214178978a82ec62c4d0d07046fbbafc6bfcaedc9c559cf51669d20e0417f463af37e6b9ba22393af15e287e158d79595adab366dfde6e697abc98b8f1756b30f5e00bc1d5e2f8452747fd1e1d962bf6b47e4c796b7ec149c20d4321d22aabdd23d00b62f57f057fa56bbbacb68c5c2bc44c1c569469cad4261dcdd5348d8e3,10001"
}</code>
            </pre>
        </div>
        
        <p class="description">アプリケーションサーバから取得した場合はThriftのデータ形式で値が返るが、ここではLINEサーバへhttpリクエストしたのを前提に後の処理を行う。</p>
        <p class="description">リクエストの返り値はjson形式であり、session_keyとrsa_keyの2つのデータに分かれる。rsa_keyはコンマで区切られているため、splitして使用する。<br>
        ここでは順に、keyname、nvalue、evalueとする。</p>
        <p class="description">session_keyはidとパスワードと一緒に使用し、各値の文字数に対応するアスキーコードを各値の先頭に配置して3つの値を連結し、メッセージを生成する。以下は直感的にわかりやすいpythonコードで記述したものである。</p>
        
        <div style="padding-top: 5px">
            <pre class="language-x hljs">
                <code class="language-X hljs" data-language="python">message  = (chr(len(session_key)) + session_key + 
            chr(len(id)) + id + 
            chr(len(password)) + password).encode('utf-8')</code>
            </pre>
        </div>
        
        <p class="description">nvalueとevalueは16進数形式のため10進数に変換し、PublicKeyを作成。作成したPublicKeyを使用してメッセージを暗号化する。
            生成された暗号キーは16進数のデータに変換して使用する。ここではcryptoとする。</p>
        <p class="dscription">暗号キーが生成できたら、それを使用してログインを行う。ここで必要になるのは以下の8つである。</p>
        
        <ol class="dotted-list" style="padding-top: 5px; padding-bottom: 5px;">
            <li>ログインタイプ</li>
            <li>プロバイダ</li>
            <li>識別子</li>
            <li>パスワード</li>
            <li>IPアドレス</li>
            <li>ログイン証明（string型のみ）</li>
            <li>e2eeVersion（Letter Sealing）</li>
            <li>システム名</li>
        </ol>
        
        <h4>LoginType</h4>
        <p class="description">ログインタイプを指定する。値はline.thriftを用いてThriftのジェネレータで自動生成されたソースコードにEnumデータが存在するためそのデータを使用する。</p>
        <div style="padding-top: 5px">
            <pre class="language-x hljs">
                <code class="language-X hljs" data-language="thrift">enum LoginType {
   ID_CREDENTIAL = 0,
   QRCODE = 1,
   ID_CREDENTIAL_WITH_E2EE = 2,
}</code>
            </pre>
        </div>
        
    </div>
    
    <footer>
        <p class="warning-message" style="padding-top: 30px;">
            copyright (c) 2019 okanon.<br>
            designer: <a class="line-link" href="https://github.com/okanon" target="_blank">@okanon</a>
        </p>
    </footer>
</body>
</html>
